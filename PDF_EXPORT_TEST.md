# PDF 导出功能测试指南

## 修复内容

已修复 PDF 导出时出现空白或样式不一致的问题。

### 主要改进

1. **使用隐藏 iframe 加载完整 HTML 文档** - 确保 `<style>` 标签和文档结构正确加载
2. **改进资源等待机制** - 确保字体和图片在导出前完全加载
3. **增强错误处理** - 提供详细的控制台日志和用户友好的错误提示
4. **优化导出参数** - 更好的清晰度和分页控制

### 技术细节

**问题根源：**
- 之前的实现使用 `container.innerHTML = html` 直接赋值完整 HTML 文档
- 这导致 `<head>` 中的 `<style>` 标签被丢弃
- 结果：导出的 PDF 缺少样式或完全空白

**解决方案：**
- 使用 `iframe.srcdoc = html` 加载完整文档
- 通过 iframe 的 `contentDocument` 访问正确渲染的内容
- 等待所有资源（字体、图片）加载完成后再导出

## 测试步骤

### 前置条件

确保服务正在运行：
- 后端：`http://localhost:8001`
- 前端：`http://localhost:5178`

### 测试场景 1：基本导出

1. 访问 `http://localhost:5178`
2. 上传一份简历 PDF 或输入简历信息
3. 等待简历在预览区显示
4. 点击右上角的**导出按钮**（下载图标）
5. 选择 **PDF** 选项
6. 等待下载完成

**预期结果：**
- ✅ 浏览器控制台显示 "开始导出 PDF..."
- ✅ 控制台显示 "使用 html 参数创建隐藏 iframe"
- ✅ 控制台显示 "成功从隐藏 iframe 提取简历内容"
- ✅ 控制台显示 "开始渲染 PDF..."
- ✅ 控制台显示 "PDF 导出成功！"
- ✅ 下载的 `resume.pdf` 文件样式与页面预览完全一致

### 测试场景 2：编辑后导出

1. 在简历预览区，点击**编辑模式**（Edit 按钮）
2. 修改 Markdown 内容（例如：更改姓名、添加项目经历）
3. 切换回**预览模式**（Preview 按钮）
4. 验证修改已显示在预览中
5. 点击**导出 PDF**

**预期结果：**
- ✅ 导出的 PDF 包含所有修改内容
- ✅ 样式与预览一致
- ✅ 没有空白页面或缺失内容

### 测试场景 3：复杂简历导出

使用包含以下内容的复杂简历：
- 长列表（10+ 项工作经历）
- 多种 section 类型（experience, generic, text）
- 特殊字符和中文字符

**预期结果：**
- ✅ 所有内容都被正确导出
- ✅ 分页合理，不会截断内容
- ✅ 中文和特殊字符显示正常
- ✅ 所有样式（颜色、字体、边距）正确

### 测试场景 4：错误处理

模拟错误情况：
1. 在简历为空时尝试导出
2. 在网络不稳定时导出

**预期结果：**
- ✅ 浏览器控制台显示详细错误信息
- ✅ 弹出用户友好的错误提示框
- ✅ 错误提示包含具体的错误原因
- ✅ 应用不会崩溃

## 验证清单

- [ ] PDF 导出成功，无空白页面
- [ ] 导出的 PDF 样式与页面预览完全一致
- [ ] 字体正确应用（不是默认字体）
- [ ] 颜色正确（标题蓝色 #0066cc，文字黑色/灰色）
- [ ] 布局正确（边距、间距、对齐）
- [ ] 图片正常显示（如果有）
- [ ] 多页简历正确分页
- [ ] 控制台没有错误日志
- [ ] 编辑后导出的内容是最新的
- [ ] HTML 导出也能正常工作

## 常见问题排查

### 问题：PDF 仍然是空白的

**可能原因：**
1. 浏览器安全策略阻止访问 iframe
2. `html2pdf.js` 库加载失败

**排查步骤：**
1. 打开浏览器控制台，查看是否有错误
2. 确认 `html2pdf.js` 是否在 package.json 中
3. 检查网络请求，确认库文件加载成功

### 问题：样式不一致

**可能原因：**
1. 字体未加载完成就开始导出
2. CSS 没有正确应用

**排查步骤：**
1. 查看控制台是否显示 "等待资源加载" 相关日志
2. 检查 `renderResumeHtmlFromSchema` 函数生成的 HTML
3. 确认 `<style>` 标签在 `<head>` 中

### 问题：导出速度很慢

**可能原因：**
1. 简历内容很长，渲染需要时间
2. 图片很多且尺寸大

**这是正常的**，html2pdf.js 需要时间将 HTML 转换为 PDF。大型简历可能需要 5-10 秒。

## 技术架构

```
用户点击导出
    ↓
exportResume("pdf", { iframe, html })
    ↓
PDF Handler
    ↓
createHiddenIframe(html) ← 创建隐藏 iframe 加载完整 HTML
    ↓
waitForResources(doc) ← 等待字体和图片加载
    ↓
提取 .resume-container 元素
    ↓
html2pdf() 转换为 PDF
    ↓
下载 resume.pdf
    ↓
清理临时 iframe
```

## 代码修改位置

- **主要文件**：`web/src/utils/export.ts`
- **新增函数**：
  - `createHiddenIframe(html: string)` - 创建隐藏 iframe
  - `waitForResources(doc: Document)` - 等待资源加载
- **重构**：PDF handler 完全重写

## 成功标准

导出功能满足以下条件即为成功：
1. ✅ 100% 的导出请求都能成功下载 PDF
2. ✅ 导出的 PDF 与页面预览视觉上完全一致
3. ✅ 错误情况有清晰的提示信息
4. ✅ 用户体验流畅，无卡顿或崩溃

